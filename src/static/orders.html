<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Order Details</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <h1 class="my-4">Order Data</h1>
    <table class="table table-striped" id="order-table">
      <thead>
        <tr>
          <th>order_id</th>
          <th>status</th>
        </tr>
        <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Order</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="edit-order-form">
                  <div class="form-group">
                    <label for="edit-order-id">Order ID</label>
                    <input type="text" class="form-control" id="edit-order-id" readonly>
                  </div>
                  <div class="form-group">
                    <label for="edit-status">Status</label>
                    <input type="text" class="form-control" id="edit-status">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-changes">Save changes</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addModalLabel">Add Order</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form id="add-order-form">
                    <div class="form-group">
                      <label for="add-order-status">Order Status</label>
                      <input type="text" class="form-control" id="add-order-status">
                    </div>
                    <div class="form-group">
                      <label for="add-customer-name">Customer Name</label>
                      <input type="text" class="form-control" id="add-customer-name">
                    </div>
                    <div class="form-group">
                        <label for="add-customer-address">Customer Address</label>
                        <input type="text" class="form-control" id="add-customer-address">
                    </div>
                    <div class="form-group">
                        <label for="add-customer-phone">Customer Phone</label>
                        <input type="text" class="form-control" id="add-customer-phone">
                    </div>
                    <div class="form-group">
                        <label for="add-customer-phone">Customer Phone</label>
                        <input type="text" class="form-control" id="add-customer-phone">
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="save-changes">Save changes</button>
                </div>
              </div>
            </div>
          </div>
      </div>
  </div>
  </thead>
  <tbody>
    <!-- Data will be inserted here by JavaScript -->
  </tbody>
  </table>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      fetch('/api/orders')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.querySelector('#order-table tbody');
          data.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
          <td>${order[0]}</td>
          <td>${order[1]}</td>   
          <td>
              <button class="btn btn-warning btn-sm edit-button" data-id="${order[0]}" data-status="${order[1]}">
                <i class="fas fa-edit"></i> Edit
              </button>
            <form method="post" action="/" style="display:inline;">
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="order_id" value="${order[0]}">
              <button type="submit" class="btn btn-danger btn-sm delete-button">
                <i class="fas fa-trash-alt"></i> Delete
              </button>
            </form>
          </td>
        `;
            tableBody.appendChild(row);
          });

          document.querySelectorAll('.delete-button').forEach(function (button) {
            button.addEventListener('click', function (event) {
              event.preventDefault();
              var orderId = this.closest('form').querySelector('input[name="order_id"]').value;

              fetch('/api/orders', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'order_id': orderId })
              })
                .then(response => response.json())
                .then(data => {
                  if (data.result === 'success') {
                    this.closest('tr').remove();
                  } else {
                    console.error('Failed to delete order');
                  }
                })
                .catch(error => console.error('Error:', error));
            });
          });


          document.querySelectorAll('.edit-button').forEach(function (button) {
            button.addEventListener('click', function () {
              var orderId = this.getAttribute('data-id');

              fetch(`/api/order/${orderId}`)
                .then(response => response.json())
                .then(orderData => {
                  document.getElementById('edit-order-id').value = orderData.order.order_id;
                  document.getElementById('edit-status').value = orderData.order.order_status;

                  $('#editModal').modal('show');
                })
                .catch(
                  error =>
                    console.error('Error fetching order data:', error)
                );
            });
          });
        })
        .catch(error => console.error('Error fetching data:', error));

      document.getElementById('save-changes').addEventListener('click', function () {
        var orderId = document.getElementById('edit-order-id').value;
        var status = document.getElementById('edit-status').value;

        fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 'order_id': orderId, 'status': status })
        })
          .then(response => response.json())
          .then(data => {
            if (data.result === 'success') {
              // Update the row in the table
              const row = document.querySelector(`button[data-id="${orderId}"]`).closest('tr');
              row.querySelector('td:nth-child(2)').textContent = status;

              $('#editModal').modal('hide');
            }
            else {
              console.error('Failed to update order');
            }
          })
          .catch(error => console.error('Error updating order:', error));
      });
    })
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>